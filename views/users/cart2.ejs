<%- include('../layouts/header.ejs') %>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Page Title</title>
    <style>
        /* Your existing styles go here */

        /* Add the provided styles for the navbar */
        .header {
            background-color: #f8f9fa;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .header__logo a {
            text-decoration: none;
            color: blue;
            font-weight: bold;
            font-size: 28px;
        }

        .header__menu ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
        }

        .header__menu li {
            margin: 0 20px;
        }

        .header__menu a {
            text-decoration: none;
            color: #333;
            font-weight: bold;
            font-size: 16px;
        }

        .header__menu .dropdown {
            display: none;
            position: absolute;
            background-color: #fff;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
            text-align: left;
            padding: 10px 0;
        }

        .header__menu .dropdown li {
            margin: 0;
        }

        .header__menu .dropdown a {
            display: block;
            padding: 10px 20px;
        }

        .header__nav__option {
            display: flex;
            align-items: center;
        }

        .header__nav__option a {
            margin-right: 20px;
        }

        .header__nav__option a img {
            width: 20px;
            height: 20px;
        }

        .header__nav__option a span {
            background-color: #333;
            color: #fff;
            padding: 5px 10px;
            border-radius: 50%;
        }
        .reduced-size {
    max-width: 50px; /* Adjust the maximum width as needed */
    height: auto;
}
    </style>
</head>

<body>
    <%- include('./userheader.ejs') %>

    <div class="untree_co-section before-footer-section">
        <div class="container">
            <div class="row mb-5">
                <form class="col-md-12" method="post">
                    <div class="site-blocks-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th class="product-thumbnail">Image</th>
                                    <th class="product-name">Product</th>
                                    <th class="product-price">Price</th>
                                    <th class="product-quantity">Quantity</th>
                                    <th class="product-total">Total</th>
                                    <th class="product-remove">Remove</th>
                                </tr>
                            </thead>
                            <tbody>
                                
                                <% if (!cart || cart.items.length===0){ %>

                                    <h1>Cart is Empty</h1>

                                    <% } else { %>


                                        <% var total=0; cart.items.forEach(item=> { %>
                                            <tr class="product-item">
                                                <td class="product-thumbnail">
                                                    <img src="/productImages/<%= item.product.images[0] %>" alt="Image" class="img-fluid reduced-size">
                                                </td>
                                                <td class="product-name">
                                                    <h2 class="h5 text-black">
                                                        <%= item.product.name %>
                                                    </h2>
                                                </td>
                                                <% const productOffer = offers.find(offer => offer.category.equals(product.category)) %>
                                                <td>
                                                    <span class="badge badge-info">
                                                        ₹<%= productOffer ? `${product.price - (productOffer.percentage * product.price) / 100}` : `No Offer` %>
                                                    </span>
                                                </td>
                                                <td>₹ &nbsp;<%= item.product.price %>
                                                </td>
                                                <td>
                                                    <div class="input-group mb-3 d-flex align-items-center quantity-container"
                                                        style="max-width: 120px;">
                                                        <div class="input-group-prepend">
                                                            <button class="btn btn-outline-black decrease"
                                                                type="button">-</button>



                                                        </div>
                                                        <input type="text" data-product-id="<%= item.product._id %>"
                                                            class="form-control text-center quantity-amount"
                                                            value="<%= item.quantity %>" max="10" disabled
                                                            placeholder="" aria-label="Example text with button addon"
                                                            aria-describedby="button-addon1">
                                                        <div class="input-group-append">
                                                            <% if (item.product.stock > 0) { %>
                                                                <button class="btn btn-outline-black increase" type="button">+</button>
                                                            <% } else { %>
                                                                <a>Out of stock</a>
                                                                
                                                            <% } %>
                                                            
                                                        </div>
                                                    </div>
                                                </td>
                                                <td><span id="subtotalId_<%= item.product._id %>">₹&nbsp;<%=
                                                            item.product.price * item.quantity %></span></td>

                                                <td><button class="btn btn-black btn-sm remove-product"
                                                        data-product-id="<%= item.product._id %>">X</button></td>
                                            </tr>



                                            <% total +=item.product.price * item.quantity }) %>

                                                <% } %>

                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="row mb-5">


                        <div class="col-md-6">

                            <a href="/"> <button class="btn btn-outline-black btn-sm btn-block">Continue
                                    Shopping</button></a>

                        </div>
                    </div>

                </div>
                <div class="col-md-6 pl-5">
                    <div class="row justify-content-end">
                        <div class="col-md-7">
                            <div class="row">
                                <div class="col-md-12 text-right border-bottom mb-5">
                                    <h3 class="text-black h4 text-uppercase">Cart Totals</h3>
                                </div>
                            </div>


                            <!-- <div class="row mb-5">
                          <div class="col-md-6">
                              <span class="text-black">Subtotal</span>
                          </div>
                          <div class="col-md-6 text-right" style="display: flex;">
                              <strong>₹</strong> &nbsp;<strong class="text-black"></strong>
                          </div>
                      </div> -->

                            <div class="row mb-5">
                                <div class="col-md-6">
                                    <span class="text-black">Total</span>
                                </div>
                                <div class="col-md-6 text-right" style="display: flex;">
                                    <strong>₹</strong> &nbsp;<strong class="text-black" id="totalprice"
                                        name="totaAmount">
                                        <%= total %>
                                    </strong>
                                </div>
                            </div>

                            <!-- <input type=""  id="-input" name="total-"> -->

                            <div class="row">
                                <div class="col-md-12">
                                    <a href="/cart/checkout">
                                        <% if (!cart || cart.items.length===0){ %>
                                            <% } else { %>
                                                <button class="btn btn-black btn-lg py-3 btn-block"
                                                    onclick="window.location='checkout.html'">Proceed To
                                                    Checkout</button>
                                                <% } %>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>




        <!-- Include jQuery from a CDN -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <script>
            $(document).ready(function () {
                // Handle click event on remove button
                $('.remove-product').on('click', function (e) {
                    e.preventDefault();

                    // Get the product ID from the data attribute
                    var productId = $(this).data('product-id');

                    // Reference the product item
                    var productItem = $(this).closest('.product-item');
                    console.log('Product Item:', productItem);

                    // Send AJAX request to remove the product
                    $.ajax({
                        type: 'POST',
                        url: `/cartremove/${productId}`,
                        success: function (response) {
                            // Handle success, update the UI or do any additional tasks
                            console.log('Product removed successfully');

                            // Check if the removal was successful on the server
                            if (response === 'success') {
                                // Remove the product item from the UI
                                productItem.remove();
                            } else {
                                console.error('Error removing product. Server response:', response);
                            }
                        },
                        error: function (error) {
                            // Handle error, show a message or log the error
                            console.error('Error removing product:', error);
                        }
                    });
                });
            });
            function updateCart(productId, quantity, totalPrice,value) {
                console.log('Sending request to update cart. ProductId:', productId, 'Quantity:', quantity);
                const totalAmount = document.getElementById('totalprice').textContent;
                $.ajax({
                    url: '/cart/updateqty',
                    method: 'POST',
                    data: {
                        productId: productId,
                        quantity: quantity,
                        totalPrice: totalAmount,
                        dosomething:value
                    },
                    success: function (response) {

                        let totalPrice = 0;
                        console.log(response)

                        if (response.subtotal && Array.isArray(response.subtotal)) {
                            response.subtotal.forEach(subtotalData => {
                                const productId = subtotalData.productId;
                                const subtotal = subtotalData.subtotal;

                                const subtotalElement = document.getElementById(`subtotalId_${productId}`);
                                if (subtotalElement) {
                                    subtotalElement.innerHTML = `₹ ${subtotal}`;
                                }
                                totalPrice = response.subtotal.reduce((acc, item) => acc + item.subtotal, 0);
                                // console.log(totalPrice)


                            });
                            document.getElementById("totalprice").innerHTML = totalPrice;

                        } else {
                            console.error('Invalid response format: response.subtotals is not an array.');
                        }


                    },
                    error: function (error) {
                        console.error('Error updating cart: ', error);
                    }
                });
            }







            $(document).ready(function () {
                $('.increase').click(function () {
                    var inputElement = $(this).closest('.quantity-container').find('.quantity-amount');
                    var productId = inputElement.data('product-id');
                    var currentQuantity = parseInt(inputElement.val());
                    var newQuantity = currentQuantity + 1;
                    var totalPriceElement = document.getElementById('totalprice');

                    var totalPrice = totalPriceElement.textContent



                    console.log('Increase button clicked. ProductId:', productId, 'New Quantity:', newQuantity, totalPrice);
                    inputElement.val(newQuantity);
                    updateCart(productId, newQuantity, totalPrice,false);
                });





                $('.decrease').click(function () {
                    var inputElement = $(this).closest('.quantity-container').find('.quantity-amount');
                    var productId = inputElement.data('product-id');
                    var currentQuantity = parseInt(inputElement.val());
                    if (currentQuantity > 1) {
                        var newQuantity = currentQuantity - 1;
                        var totalPriceElement = document.getElementById('totalprice');

                        var totalPrice = totalPriceElement.textContent


                        console.log('Decrease button clicked. ProductId:', productId, 'New Quantity:', newQuantity, totalPrice);
                        inputElement.val(newQuantity);
                        updateCart(productId, newQuantity, totalPrice,true);
                    }
                });
            });






        </script>
</body>

</html>